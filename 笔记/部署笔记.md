# 部署笔记

假设服务器名 vultr, 可通过 `ssh vultr` 连接

## 1. 上传代码

在服务器创建仓库

```zsh
cd ~
git init zuowen.jackjyq.com
cd zuowen.jackjyq.com
git config --local receive.denyCurrentBranch updateInstead
```

在本地电脑，上传代码

```zsh
git remote add vultr vultr:~/zuowen.jackjyq.com
git push
```

在服务器安装依赖

```zsh
python3.10 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 测试能否运行，测试完按 Ctrl+C 退出
python 网站服务器.py
```

## 2. 配置 gunicorn 服务

在服务器配置 gunicorn

```zsh
sudo vim /etc/systemd/system/zuowen.jackjyq.com.service
```

粘贴如下内容

```ini
[Unit]
Description=zuowen.jackjyq.com
After=network.target

[Service]
User=jack
Group=www-data
WorkingDirectory=/home/jack/zuowen.jackjyq.com
Environment="PATH=/home/jack/zuowen.jackjyq.com/venv/bin"
ExecStart=/home/jack/zuowen.jackjyq.com/venv/bin/gunicorn --workers 1 --timeout 300 --bind unix:zuowen.jackjyq.com.sock -m 007 网站服务器:app

[Install]
WantedBy=multi-user.target
```

在服务器启动服务

```zsh
sudo systemctl start zuowen.jackjyq.com
sudo systemctl enable zuowen.jackjyq.com
sudo systemctl status zuowen.jackjyq.com
```

## 3. 配置 Nginx 服务

在服务器配置 Nginx

```zsh
sudo vim /etc/nginx/conf.d/jackjyq.com.conf
```

粘贴如下内容

```conf
server {
        listen 80;
        server_name zuowen.jackjyq.com;
        location / {
                include proxy_params;
                proxy_pass http://unix:/home/jack/zuowen.jackjyq.com/zuowen.jackjyq.com.sock;
        }
}
```

在服务器启动服务

```zsh
sudo nginx -t
sudo systemctl restart nginx
```

## 4. 配置 HTTPS

在服务器运行

```zsh
sudo certbot --nginx
```

## 5. 升级部署

如代码修改，在本地运行

```zsh
git push vultr & ssh -t vultr 'sudo systemctl restart zuowen.jackjyq.com'
```

### 参考

- [How To Serve Flask Applications with Gunicorn and Nginx on Ubuntu 20.04](https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-gunicorn-and-nginx-on-ubuntu-20-04)
- [connect() to unix:/run/gunicorn.sock failed (13: Permission denied)](https://www.digitalocean.com/community/tutorials/how-to-set-up-django-with-postgres-nginx-and-gunicorn-on-ubuntu-20-04)